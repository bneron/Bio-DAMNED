---

- name: creating bank "{{ bank_name }}" directory
  become: yes
  become_user: "{{ bank_user }}"
  file: path={{ bank_root }}/{{ bank_name }} state=directory owner={{ bank_user }} group={{ bank_group }} mode=0775

- name: creating bank "{{ bank_name }}" subtree directories
  become: yes
  become_user: "{{ bank_user }}"
  file: path={{ bank_root }}/{{ bank_name }}/{{ item }} state=directory  owner={{ bank_user }} group={{ bank_group }} mode=0775
  with_items:
    - uncompressed
    - fasta
    - golden
    - blast2

- name: downloading "{{ bank_name }}"
  become: yes
  become_user: "{{ bank_user }}"
  # because of bug https://github.com/ansible/ansible-modules-core/issues/3661
  # on ansible version 2.0.2.0 we cxan not use get_url : workaround use command
  #  get_url: ftp://ftp.ncbi.nih.gov/genomes/archive/old_genbank/Bacteria/Mycobacterium_tuberculosis_CDC1551_uid223/AE000516.gbk
  #curl ftp://ftp.ncbi.nih.gov/genomes/archive/old_genbank/Bacteria/Mycobacterium_tuberculosis_CDC1551_uid223/AE000516.gbk -o {{bank_name}}.gbk
  command: curl {{ bank_src }} -o {{ bank_root }}/{{ bank_name }}/uncompressed/{{bank_name}}.gbk


- name: reformating "{{ bank_name }}" in fasta format
  become: yes
  become_user: "{{ bank_user }}"
  #shell: module load dbtools && flat2fasta -d {{ bank_name }} {{ bank_name }}.gbk >> {{ bank_root }}/{{ bank_name }}/fasta/{{ bank_name }}.fa
  shell: >
    squizz -c FASTA -f GENBANK {{ bank_name }}.gbk >> {{ bank_root }}/{{ bank_name }}/fasta/{{ bank_name }}.fa
    chdir={{ bank_root }}/{{ bank_name }}/uncompressed

- name: running squizz on "{{ bank_name }}"  to check format
  become: yes
  become_user: "{{ bank_user }}"
  shell: squizz {{ bank_name }}.fa chdir={{ bank_root }}/{{ bank_name }}/fasta
  register: format

- name: Checking fasta format
  fail: msg="{{ bank_name }}" not correctly formated "{{ format.stderr }}"
  when: not 'FASTA' in format.stderr

- name: reating links to fasta format
  become: yes
  become_user: "{{ bank_user }}"
  file: >
    src={{bank_root}}/{{ bank_name }}/fasta/{{ bank_name }}.fa
    dest={{bank_root}}/fasta/{{bank_name}}.fa
    state=link

- name: cleaning "{{ bank_name }}" golden indexes
  become: yes
  become_user: "{{ bank_user }}"
  file: path={{bank_root}}/{{bank_name}}/golden/{{ bank_name }}}.{{ item }} state=absent
  with_items:
    - acx
    - dbx
    - idx

- name: creating "{{ bank_name }}" new golden indexes
  become: yes
  become_user: "{{ bank_user }}"
  shell: >
    goldin -d {{ bank_name }} {{ bank_name }} {{ bank_root }}/{{ bank_name }}/uncompressed/{{ bank_name }}.gbk
    chdir={{ bank_root }}/{{ bank_name }}/golden

- name: creating "{{ bank_name }}" links to golden indexes
  become: yes
  become_user: "{{ bank_user }}"
  file: >
    src={{bank_root}}/{{ bank_name }}/golden/{{ bank_name }}.{{ item }}
    dest={{bank_root}}/index/golden/{{ bank_name }}.{{ item }}
    state=link
  with_items:
    - acx
    - dbx
    - idx

- name: cleaning "{{ bank_name }}" blast2 indexes
  become: yes
  become_user: "{{ bank_user }}"
  file: path={{bank_root}}/{{bank_name}}/blast2/{{ bank_name }}}.{{ item }} state=absent
  with_items:
    - nhr
    - nin
    - nsq

- name: creating blast2 indexes
  become: yes
  become_user: "{{ bank_user }}"
  #formatdb  -t "{{ bank_name }}" -p F -n "{{ bank_name }}" -i {{ bank_root }}/{{ bank_name }}/fasta/{{ bank_name }}.fa -l /dev/null
  shell: >
    makeblastdb -title {{ bank_name }} -in {{ bank_root }}/{{ bank_name }}/fasta/{{ bank_name }}.fa -dbtype nucl
    chdir={{ bank_root }}/{{ bank_name }}/blast2

- name: moving and renaming "{{ bank_name }}" blast indexes in right directory
  become: yes
  become_user: "{{ bank_user }}"
  command: mv {{ bank_root }}/{{ bank_name }}/fasta/{{ bank_name }}.fa.{{ item }} {{ bank_root }}/{{ bank_name }}/blast2/{{ bank_name }}.{{ item }}
  with_items:
    - nhr
    - nin
    - nsq

- name: creating links to blast2 indexes
  become: yes
  become_user: "{{ bank_user }}"
  file: >
    src={{bank_root}}/{{ bank_name }}/blast2/{{ bank_name }}.{{ item }}
    dest={{bank_root}}/index/blast2/{{ bank_name }}.{{ item }}
    state=link
  with_items:
    - nhr
    - nin
    - nsq

- name: creating link for fasta
  become: yes
  become_user: "{{ bank_user }}"
  file: >
    src={{bank_root}}/{{ bank_name }}/fasta/{{ bank_name }}.fa
    dest={{bank_root}}/fasta/{{ bank_name }}.fa
    state=link
